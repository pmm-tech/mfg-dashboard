version: '3.8'

name: mfg-dashboard-prod

services:
  # Init service to set up volumes and permissions
  init:
    image: purwaren/mfg-dashboard:1.0.0
    user: root
    command: sh -c |
      # Copy application files from image to volumes
      cp -a /var/www/html/. /mnt/app-data/ || true
      cp -a /var/www/framework/. /mnt/framework-data/ || true
      # Set proper permissions
      chown -R www-data:www-data /mnt/app-data /mnt/framework-data || true
      chmod -R 755 /mnt/app-data /mnt/framework-data || true
      # Ensure writable directories exist
      mkdir -p /mnt/app-data/assets /mnt/app-data/protected/runtime || true
      chown -R www-data:www-data /mnt/app-data/assets /mnt/app-data/protected/runtime || true
      chmod -R 775 /mnt/app-data/assets /mnt/app-data/protected/runtime || true
      echo "Init completed"
    volumes:
      - app-data:/mnt/app-data
      - framework-data:/mnt/framework-data
    restart: "no"

  # PHP-FPM Container
  php-fpm:
    image: purwaren/mfg-dashboard:1.0.0
    container_name: mfg-dashboard-php-fpm
    user: "33:33"  # www-data user ID
    depends_on:
      - init
    environment:
      # Database Configuration (from Secret)
      - DB_HOST=${DB_HOST:-mysql-service.default.svc.cluster.local}
      - DB_NAME=${DB_NAME:-mode_dashboard}
      - DB_USER=${DB_USER:-dashboard_user}
      - DB_PASSWORD=${DB_PASSWORD:-CHANGE_ME_SECURE_PASSWORD}
      - DB_CHARSET=${DB_CHARSET:-utf8mb4}
      - DB_PORT=${DB_PORT:-3306}
      
      # Application Security (from Secret)
      - APP_SALT=${APP_SALT:-CHANGE_ME_TO_RANDOM_SALT_STRING}
      
      # Application Configuration (from ConfigMap)
      - APP_TIMEZONE=${APP_TIMEZONE:-Asia/Jakarta}
      - APP_TIMEOUT=${APP_TIMEOUT:-900}
      - APP_ADMIN_EMAIL=${APP_ADMIN_EMAIL:-webmaster@example.com}
      - APP_COMPANY_NAME=${APP_COMPANY_NAME:-Mode Fashion Group}
      - APP_PAGINATION_SIZE=${APP_PAGINATION_SIZE:-10}
      
      # Yii Framework Configuration (from ConfigMap)
      - YII_DEBUG=${YII_DEBUG:-false}
      - YII_TRACE_LEVEL=${YII_TRACE_LEVEL:-0}
      
      # PHP-FPM Configuration (from ConfigMap)
      - PHP_FPM_LISTEN=${PHP_FPM_LISTEN:-127.0.0.1:9000}
      - PHP_FPM_PM_MAX_CHILDREN=${PHP_FPM_PM_MAX_CHILDREN:-50}
      - PHP_FPM_PM_START_SERVERS=${PHP_FPM_PM_START_SERVERS:-5}
      - PHP_FPM_PM_MIN_SPARE_SERVERS=${PHP_FPM_PM_MIN_SPARE_SERVERS:-5}
      - PHP_FPM_PM_MAX_SPARE_SERVERS=${PHP_FPM_PM_MAX_SPARE_SERVERS:-35}
      
      # PHP Timezone
      - PHP_TIMEZONE=${PHP_TIMEZONE:-Asia/Jakarta}
    volumes:
      - app-data:/var/www/html
      - framework-data:/var/www/framework
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "sh", "-c", "ps aux | grep '[p]hp-fpm: master' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx Container
  nginx:
    image: purwaren/mfg-dashboard-nginx:1.0.0
    container_name: mfg-dashboard-nginx
    user: "1001:1001"  # Bitnami nginx user ID
    depends_on:
      php-fpm:
        condition: service_healthy
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - app-data:/var/www/html:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 64M
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  app-data:
    driver: local
  framework-data:
    driver: local

networks:
  app-network:
    driver: bridge
